{% extends "base.html" %}
{% block title %}My Todos{% endblock title %}

{% block content %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white shadow rounded-lg">
    <h2 class="page-title">My Todos</h2>

    <div class="mb-4 flex justify-between">
        <a href="{% url 'add_todo' %}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition
            {% if incomplete_count >= 20 %} opacity-50 cursor-not-allowed pointer-events-none {% endif %}">
            + Add Todo
        </a>
        <span class="text-gray-600 text-sm">
            Total: {{ todos|length }} | Completed: {{ completed_count }} | Incomplete: {{ incomplete_count }}
        </span>
    </div>

    {% if todos %}
        <ul class="space-y-4">
            {% for todo in todos %}
                <li class="p-4 rounded-lg {% if todo.is_completed %}bg-green-50{% else %}bg-gray-50{% endif %} hover:shadow-md transition">
                    <div>
                        <h3 class="font-semibold {% if todo.is_completed %}line-through text-gray-500{% endif %} break-words">
                            {{ todo.title }}
                        </h3>
                        <p class="text-sm text-gray-500">
                            Priority: {{ todo.priority }}
                            {% if todo.due_date %} | Due: {{ todo.due_date|date:"M d, Y" }} {% endif %}
                        </p>
                        <p class="text-xs {% if todo.is_completed %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if todo.is_completed %}✔ Completed{% else %}⏳ Incomplete{% endif %}
                        </p>
                    </div>

                    <div class="mt-3 flex flex-wrap gap-2">
                        {# Show Mark Complete button only if not completed and due date is today or in the past #}
                        {% if not todo.is_completed %}
                            {% if not todo.due_date or todo.due_date <= today %}
                                <a href="{% url 'mark_complete' todo.pk %}" 
                                   class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                                    Mark Complete
                                </a>
                            {% endif %}
                        {% else %}
                            {% if not todo.due_date or todo.due_date <= today %}
                                <a href="{% url 'mark_incomplete' todo.pk %}" 
                                   class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">
                                    Mark Incomplete
                                </a>
                            {% endif %}
                        {% endif %}

                        <a href="{% url 'update_todo' todo.pk %}" 
                           class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            Edit
                        </a>
                        <a href="{% url 'todo_details' todo.pk %}" 
                           class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm">
                            Details
                        </a>
                        <a href="{% url 'delete_todo' todo.pk %}" 
                           class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                            Delete
                        </a>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-gray-500 text-center">
            No todos found. 
            <a href="{% url 'add_todo' %}" class="text-blue-600 hover:underline">Add a new todo</a>
        </p>
    {% endif %}
</div>
{% endblock %}
